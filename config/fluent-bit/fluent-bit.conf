[SERVICE]
    Flush        1
    Daemon       off
    Log_Level    info
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020
    Parsers_File parsers.conf

# Collect application logs
[INPUT]
    Name              tail
    Path              /var/log/legal-ai/**/*.log
    Tag               legal-ai.logs
    Refresh_Interval  5

[INPUT]
    Name              tail
    Path              /var/log/legal-ai/**/*.jsonl
    Tag               legal-ai.audit
    Refresh_Interval  5

# Collect Docker container logs
[INPUT]
    Name              tail
    Path              /var/lib/docker/containers/*/*-json.log
    Tag               docker.logs
    Parser            docker
    Path_Key          container_path
    Refresh_Interval  5

# Parse JSON and extract the message field for app logs
[FILTER]
    Name        parser
    Match       legal-ai.*
    Key_Name    log
    Parser      json
    Reserve_Data On

# Add metadata for application logs
[FILTER]
    Name        modify
    Match       legal-ai.*
    Add         service legal-ai
    Add         log_source fluent-bit

# Extract container ID from path for Docker logs
[FILTER]
    Name        parser
    Match       docker.logs
    Key_Name    container_path
    Parser      container_path_parser
    Reserve_Data On

# Add service field for Docker logs
[FILTER]
    Name        modify
    Match       docker.*
    Add         service container
    Add         log_source docker

# Nest non-message fields under 'details' to make message primary for app logs
[FILTER]
    Name        nest
    Match       legal-ai.*
    Operation   nest
    Wildcard    event_type,user_email,response_tokens,sources_accessed,document_id,filename,file_size,user_role,ip_address,client_matter,processing_time_ms,severity,alert_type
    Nest_under  details

# Output application logs
[OUTPUT]
    Name        http
    Match       legal-ai.*
    Host        victorialogs
    Port        9428
    URI         /insert/jsonline?_stream_fields=service,log_source&_msg_field=message&_time_field=timestamp
    Format      json_lines

# Output Docker logs
[OUTPUT]
    Name        http
    Match       docker.*
    Host        victorialogs
    Port        9428
    URI         /insert/jsonline?_stream_fields=service,container_id&_msg_field=log&_time_field=time
    Format      json_lines 